---
title: "Przestrzenne bazy danych: porównanie bibliotek `spatstat` oraz `sp`"
author: 
    - Aleksandra Dzieniszewska
    - Eryk Warchulskki
date: x
output:
  html_notebook:
    toc: true
    toc_depth: 3
---


# Wprowadzenie 
## Zakres i cel projektu


Niniejszy projekt skupia się na porównaniu ze sobą dwóch biblotek dedykowanych danym przestrzennym w języku R, tj.:

* biblotece `spatstat` (w wersji `1.62-2 Shape-shifting lizard`)
* biblotece `sp` (w wersji `1.3-2`).


W projekcie zostaną porównane ze sobą reprezentacje danych przestrzennych przez obie bibloteki oraz ich zasób możliwości do

- wizualizacji
- przetwarzania
- transformacji układu współrzędnych 
- odczytu i zapisu danych.

W ramach przeprowadzonych porównań stosowane będą różne metryki -- od tych wyrażalnych liczbowo jak czas wykonania lub zajętość pamięci po subiektywne odczucia użytkownika. 


W sekcji pierwszej omówiona zostanie reprezentacja danych przestrzennych, która występuje w badanych pakietach, oraz zamieszczona jest tam krótka charakterystyka obu pakietów. Sekcja druga dotyczy kwestii zależności biblotek od biblotek zewnętrznych. Sekcja trzecia i czwarta omawia kolejno: metody wizualizacji oraz konstrukcje obiektów geometrycznych. Zbadany tam zostanie i omówiony zostanie czas wykonania oraz UX (ang. _user experience_). Sekcja piąta dotyczy transformacji układu współrzędnych, a sekcja szósta -- metod zapisu o dycztu danych. Sekcja przedostatnia -- siódma -- traktować będzie o transformacjach między natywnymi typami języka `R` oraz między obiema biblotekami. Dokument zakończony jest podsumowaniem, wnioskami, płynącymi z użytkowania obu pakietów, oraz biblografią użytą przez autorów w ramach źródła informacji. 


# Reprezentacja danych 
## Biblioteka `spatstat`

Bibloteka `spatstat` stanowi zbiór funkcji dedykowanych danym przestrzennym. Dokumentacja bibloteki złożona jest z ponad $1700$ stron, co daje około $850$ różnych funkcji. Po samej liczbie dostępnych metod można dojść do wniosku, że pakiet ten oferuje znacznie więcej, niż konstrukcje, wizualizacje czy zapis/odczyt danych przestrzennych. `Spatstat` wspiera m.in.:

- eksploracyjną analizę danych
- modelowanie (wraz z audytem uzyskanych modeli) oraz wnioskowanie statystyczne 
- symulacje dwuwymiarowych procesów stochastycznych (t.zw. pól losowych).

W projekcie te aspekty pakietu nie zostaną omówione, ponieważ pakiet `sp` nie zawiera żadnych metod, które pozwalałyby realizować powyższe zagadnienia.


*Reprezentacja danych* w omawianym pakiecie opiera się na czterech klasach zaimplementowanych w prostym systemie obiektowości języka `R`, tj. w systemie `S3`. System ten opiera się na funkcjach generycznych i przez to różni się od systemów obiektowości spotykanych we współczesnych językach obiektowych lub wspierających obiektowość (`Java` lub `Python`) opartą na t.zw. _message-passing_. 

Klasy służące do reprezentacji obiektów przestrzennych w biblotece `spatstat` są następujące:

1. Klasa `ppp`
2. Klasa `owin`
3. Klasa `im`
4. Klasa `psp`

Poniżej zostanie scharakteryzowana każda z klas.

### ppp

Klasa `ppp` reprezentuje jeden z obiektów geometrycznych modelowanych przez system typów bibloteki `spatstat`, tj. zbiór punktów (na płaszczyźnie). 

Obiekt `ppp` tworzony jest przez konstruktor `spatstat::ppp()`, który przyjmuje jako parametry koordynaty przestrzenne (`x`, `y`) oraz -- opcjonalnie -- etykietki przyporządkowane punktom (`marks`). Na obiekty `marks` nałożona jest warunek bycia reprezentantem typu `factor` (typ podstawowy języka `R`, który służy do reprezentacji wielkości kategorycznych). Ponadto, z każdym obiektem `ppp` związane jest _okno_, w którym ten obiekt się znajduje, tj. dwuwymiarowa płaszczyzna. Konstruktor obiektu w przypadku braku specyfikacji okna (obiekt typu `owin` jest omawiany w następnej podsekcji) umieszcza punkty w oknie $[0, 1]^{2}$, a te których koordynaty przestrzenne wykraczają poza domyślny obszar -- usuwa. 

Z obiektami typu `ppp` związane są następujące funkcje:

* `spatstat::as.ppp()` 
* `spatstat::plot.ppp()`
* `spatstat::summary.ppp()`
* `spatstat::scapp()`


Sposób utworzenia i wykonywania pewnych operacji na tym typie prezentuje poniższy listing:


```{R}
library(magrittr)

points_number = 50

points = points_number %>% spatstat::ppp(x = runif(.), y = runif(.), xrange = c(0, 1), yrange = c(0, 1))

points 

points %>% summary()

points %>% plot("Punkty")


```


### owin

Klasa `owin` reprezentuje jeden z obiektów geometrycznych modelowanych przez system typów bibloteki `spatstat`, tj. dwuwymiarową płaszczyznę. 

Obiekt `owin` tworzony jest przez konstruktor `spatstat::owin()` i wyróżnia się trzy podtypy tego obiektu: 

* `rectangle` (prostokąt)
* `polygonal` (wielokąt)
* `mask` (macierz z wartościami w zbiorze ${0, 1}$)

Obiekty typu `owin` mogą przyjmować dowolny kształt, być wizualizowane bez naniesionych punktów oraz dostępne są specyficzne dla powierzchni metody jak:


* `spatstat::as.ppp()` 
* `spatstat::plot.ppp()`
* `spatstat::summary.ppp()`
* `spatstat::area.owin()` 
* `spatstat::aperimeter()` 
* `spatstat::adiameter.owin()`
* `spatstat::boundingbox()`

Sposób utworzenia i wykonywania pewnych operacji na tym typie prezentuje poniższy listing:

```{R}

window = spatstat::owin(xrange = c(0, 3), yrange = c(0, 5))

window %>% spatstat::area()

window %>% plot(main = "Okno")

```

### im

Klasa `im` reprezentuje dwuwymiarowy obraz złożony z pikseli. 

Obiekt `im` tworzony jest przez konstruktor `spatstat::im()`, który przyjmuje jako parametry wejściowe:

* macierz wartości `v` oraz jej wymiarowość `dim` 
* szerokość `xrange` oraz długość `yrange` okna, które obejmuje obraz 
* szerokość `xstep` oraz długość `ystep` piksela 
* wektor koordynatów określających centra pikseli `xcol` oraz `yrow`


 
 
Sposób utworzenia obiektu `im` prezentuje poniższy listing:


```{R}

value_mat = matrix(runif(100), nrow=30, ncol=40)

pixel_image = spatstat::im(value_mat) 

pixel_image %>% plot(main = 'Szum bialy')

```

### psp 

Klasa `psp` reprezentuje linię i jest typem pochodnym typu `ppp`. Obiekt `psp` tworzony jest przez konstruktor `spatstat::psp()`.

Sposób utworzenia powyższego typu prezentuje poniższy listing:

```{R}
segment_line = psp(x0 = runif(1), y0 = runif(1), x1 = runif(1), y1= runif(1), window=owin())

segment_line %>% plot(main="Linia")

```

## Bibloteka `sp`

Bibloteka `sp` jest pakietem funkcji dedykowanych ściśle pod wizualizacje oraz transformacje danych przestrzennych. Pakiet ten nie wspiera czynności dodatkowych, które można wykonywać na danych przestrzennych jak modelowanie lub przeprowadzenie symulacji. 

Oparty jest on na innym systemie klas niż pakiet `spatstat` -- na znacznie bardziej złożonym i formalnie ścisłym systemie `S4`. 

*Reprezentacja danych* w biblotece `sp` oparta jest na 7 klasach w wersji bez dodatkowych atrybutów numerycznych lub kategorycznych (np. `SpatialPoints`) lub z dodatkowymi atrybutami (np. `SpatialPointsDataFrame`). Ponadto, w proponowanym systemie klas przez `sp` istnieje klasa abstrakcyjna `Spatial`, która zawiera metadane wspólnego dla każdego obiektu geometrycznego tej bibloteki.

Poniżej zostaną omówione wszystkie dostępne klasy w wersji dodatkowych atrybutów z wyłączeniem klasy `SpatialPointsDataFrame`, co wynika z faktu bardzo podobnego sposobu konstruowania obiektów tego rodzaju przy użyciu standardowych konstruktorów.

### Spatial 

Klasa abstrakcyjna `Spatial` zawiera następujące metody abstrakcyjne: 

* `sp::dimensions()`
* `sp::bbox()`
* `sp::coordinates()`
* `sp::spplot()`
* `sp::dimensions()`


### SpatialPoints

Konstrukcja obiektu `SpatialPoints` odbywa się przy pomocy konstruktura `sp::SpatialPoints()`, który jako parametr wejściowy przyjmuje `coords`, będący macierzą (lub ramką danych `data.frame`) $n$-wymiarową.

W przypadku potrzeby konstrukcji obiektu z dodatkowymi danymi, tj. typów `Spatial_DataFrame`, konstruktor przyjmuje parametr `data`, będący obiektem typu `data.frame` o liczbie wierszy równej `coords`.


W pakiecie istnieje również klasa `SpatialMultiPoint`, która jest rozszerzeniem `SpatialPoints` o możliwość przechowywania koordynatów wielu punktów, tj. 

```{R}
SpatialMultiPoints(list(
                    cbind(rnorm(3, 10), rnorm(3, 10)), # koordynaty 1...
                    cbind(rnorm(5, 10), rnorm(5, 0)) # koordynaty 2...
                    ))
```

Utworzenie `SpatialPoints` prezentuje poniższy listing:

```{R}
library(tidyverse)

coordinates = tibble::tibble(x1 = runif(10), x2 = runif(10), x3 = runif(10))

points = coordinates %>% sp::SpatialPoints()

points 

points %>% plot()

```


Natomiast utworzenie `SpatialPointsDataFrame` wygląda następująco:

```{R}

coordinates = tibble::tibble(x1 = runif(10), x2 = runif(10), x3 = runif(10))

random_data = tibble::tibble(height = runif(10), weight = runif(10), iq = runif(10))

points = coordinates %>% sp::SpatialPointsDataFrame(data = random_data)

points %>% summary()

points %>% spplot()

```

### Grids
Klasa `SpatialGrid` oraz `SpatialPixels` reprezentują obiekty geometryczne typu siatka/krata
przy czym obiekty klasy `SpatialGrid` nie przechowują koordynatów przestrzennych, a _cały_ obiekt siatki. 
Ponadto klasa `SpatialGridDataFrame` przechowuje w każdym wierszu dodatkowe atrybuty numeryczne lub kategoryczne na każdą komórkę siatki.

```{R}
grid_topology = sp::GridTopology(cellcentre.offset = c(1,1,2), cellsize=c(1,1,1), cells.dim = c(3,4,6))

grid_object = sp::SpatialGrid(grid_topology)

summary(grid_object)

grid_object %>% plot("Siatka")
```

### Line, Lines, SpatialLines

Obiekt klasy `Line` reprezentują łamaną, która jest tworzona przez podanie wektorów dwóch współprzędnych do konstruktura `sp::Line()`. W celu utworzenia obiektu, który daje się wizualizować należy wywołać konstruktor `sp::SpatialLines()`, który jako parametr wejściowy przyjmuje listę obiektów `sp::Lines()`, a ta z kolei tworzona jest z list obiektów typu `Line`. Możliwe jest również dodanie atrybutów w postaci ramki danych, aby utworzyć obiekt `SpatialLinesDataFrame`. 

Według autorów pakiet `sp` poza funkcjami do wizualizacji łamanych nie zawiera zbyt wiele użytecznych funkcji.

Poniższy listing prezentuje sposób utworzenia obiektu `SpatialLines`.

```{R}
l1 = cbind(c(1,2,3), c(3,2,2)) # koordynaty 

sp_line1 = sp::Line(l1)

sp_lines = sp::Lines(list(sp_line1), ID = "a")

sp_final_line = sp::SpatialLines(list(sp_lines))

sp_final_line %>% plot(main = "Linia <(1, 3), (2, 2), (3, 2)>")
```


### Polygon, Polygons, SpatialPolygons

Obiekt klasy `Polygon` służy do reprezentacji wielokątów i jest konstruowany w sposób podobny do obiektu typu `Line`, tj. podania wektorów koordynatów dla współrzędnej $x$ oraz $y$. Po utworzeniu obiektu typu `Polygon` tworzony jest obiekt `Polygons`, zawierający listę obiektów `Polygon` oraz obligatoryjny identyfikator obiektu.


```{R}
polygon = sp::Polygon(cbind(c(2,4,4,1,2),c(2,3,5,4,2))) 
polygons = sp::Polygons(list(polygon), ID = "polygon_102")
spatial_polygons = sp::SpatialPolygons(list(polygons))

spatial_polygons %>% plot(main = "Wielobok")
            

```

## Uwagi

Reprezentacja obiektów przestrzennych oferowana przez pakiet `sp` jest znacznie bogatsza oraz jest oparta na bardziej złożonym systemie klas, niż reprezentacja w pakiecie `spatstat`. 

Sposób tworzenia obiektów w obu bibliotekach jest do siebie dosyć zbliżony, tj. przez podanie koordynatów przestrzennych w postaci wektora liczb rzeczywistych. W tej kwestii na korzyść pakietu `sp` przemawia bardzo łatwy sposób tworzenia obiektów przestrzennych o wymiarowości większej niż dwa. Typy biblioteki `spatstat` jak np. `ppp` ograniczony jest wyłącznie do dwóch wymiarów. W najnowszych wersjach pakietu `spatstat` istnieje co prawda typ `pp3`, w którym można tworzyć punkty trójwymiarowe lub typ `ppx` dedykowany do obiektów wielowymiarowych z dodatkowym wymiarem czasu, lecz typ ofery przez pakiet `sp` jest znacznie bardziej naturalny.


Dosyć niewygodnym aspektem pakietu `spatstat` przy tworzeniu obiektów `ppp` jest konieczność specyfikowania płaszczyzny, w której punkty są zawarte. W przypadku, w którym użytkownik losuje punkty z rozkładu o nieograniczonym nośniku lewo- i/lub prawostronnie, taka konieczność specyfikacji jest uciążliwa. 
Wydaje się, że domyślne parametry obiektu `owin` powinny być zależne od minimalnych i maksymalnych parametrów obiektu `ppp`.

Na korzyść pakietu `sp` jest również sposób tworzenia łamanych, który jest intuicyjny i w nieznaczny sposób różni się od tworzenia obiektów `polygon`.

# Zależność od pakietów zewnętrznych
TODO
# Wizualizacja danych przestrzennych
TODO
# Konstrukcja obiektów geometrycznych
TODO
## Obiekty podstawowe
TODO
## Obiekty złożone
TODO
# Transformacje układu współrzędnych
TODO
## Typy transformacji
TODO
## Czas wykonania
TODO
# Zapis i wczytanie danych
TODO
## Operacje wczytania danych
TODO
### Dostępne formaty danych
TODO
### Czas wykonania 
TODO
## Operacje zapisu danych
TODO
### Dostępne formaty danych
TODO
### Czas wykonania 
TODO
# Konwersje typów
TODO